
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cache Keys &#8212; BuildStream 0.1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cache-keys">
<span id="cachekeys"></span><h1>Cache Keys<a class="headerlink" href="#cache-keys" title="Permalink to this headline">¶</a></h1>
<p>Cache keys for artifacts are generated from the inputs of the build process
for the purpose of reusing artifacts in a well-defined, predictable way.</p>
<div class="section" id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h2>
<p>Cache keys are SHA256 hash values generated from a pickled Python dict that
includes:</p>
<ul class="simple">
<li>Environment (e.g., project configuration and variables)</li>
<li>Element configuration (details depend on element kind, <code class="docutils literal"><span class="pre">Element.get_unique_key()</span></code>)</li>
<li>Sources (<code class="docutils literal"><span class="pre">Source.get_unique_key()</span></code>)</li>
<li>Dependencies (depending on cache key type, see below)</li>
<li>Public data</li>
</ul>
</div>
<div class="section" id="cache-key-types">
<h2>Cache Key Types<a class="headerlink" href="#cache-key-types" title="Permalink to this headline">¶</a></h2>
<p>There are two types of cache keys in BuildStream, <code class="docutils literal"><span class="pre">strong</span></code> and <code class="docutils literal"><span class="pre">weak</span></code>.</p>
<p>The purpose of a <code class="docutils literal"><span class="pre">strong</span></code> cache key is to capture the state of as many aspects
as possible that can have an influence on the build output. The aim is that
builds will be fully reproducible as long as the cache key doesn’t change,
with suitable module build systems that don’t embed timestamps, for example.</p>
<p>A <code class="docutils literal"><span class="pre">strong</span></code> cache key includes the strong cache key of each build dependency
(and their runtime dependencies) of the element as changes in build dependencies
(or their runtime dependencies) can result in build differences in reverse
dependencies. This means that whenever the strong cache key of a dependency
changes, the strong cache key of its reverse dependencies will change as well.</p>
<p>A <code class="docutils literal"><span class="pre">weak</span></code> cache key has an almost identical structure, however, it includes
only the names of build dependencies, not their cache keys or their runtime
dependencies. A weak cache key will thus still change when the element itself
or the environment changes but it will not change when a dependency is updated.</p>
<p>For elements without build dependencies the <code class="docutils literal"><span class="pre">strong</span></code> cache key is identical
to the <code class="docutils literal"><span class="pre">weak</span></code> cache key.</p>
</div>
<div class="section" id="strict-build-plan">
<h2>Strict Build Plan<a class="headerlink" href="#strict-build-plan" title="Permalink to this headline">¶</a></h2>
<p>This is the default build plan that exclusively uses <code class="docutils literal"><span class="pre">strong</span></code> cache keys
for the core functionality. An element’s cache key can be calculated when
the cache keys of the element’s build dependencies (and their runtime
dependencies) have been calculated and either tracking is not enabled or it
has already completed for this element, i.e., the <code class="docutils literal"><span class="pre">ref</span></code> is available.
This means that with tracking disabled the cache keys of all elements could be
calculated right at the start of a build session.</p>
<p>While BuildStream only uses <code class="docutils literal"><span class="pre">strong</span></code> cache keys with the strict build plan
for the actual staging and build process, it will still calculate <code class="docutils literal"><span class="pre">weak</span></code>
cache keys for each element. This allows BuildStream to store the artifact
in the cache with both keys, reducing rebuilds when switching between strict
and non-strict build plans. If the artifact cache already contains an
artifact with the same <code class="docutils literal"><span class="pre">weak</span></code> cache key, it’s replaced. Thus, non-strict
builds always use the latest artifact available for a given <code class="docutils literal"><span class="pre">weak</span></code> cache key.</p>
</div>
<div class="section" id="non-strict-build-plan">
<h2>Non-strict Build Plan<a class="headerlink" href="#non-strict-build-plan" title="Permalink to this headline">¶</a></h2>
<p>The non-strict build plan disables the time-consuming automatic rebuild of
reverse dependencies at the cost of dropping the reproducibility benefits.
It uses the <code class="docutils literal"><span class="pre">weak</span></code> cache keys for the core staging and build process.
I.e., if an artifact is available with the calculated <code class="docutils literal"><span class="pre">weak</span></code> cache key,
it will be reused for staging instead of being rebuilt. <code class="docutils literal"><span class="pre">weak</span></code> cache keys
can be calculated early in the build session. After tracking, similar to
when <code class="docutils literal"><span class="pre">strong</span></code> cache keys can be calculated with a strict build plan.</p>
<p>Similar to how strict build plans also calculate <code class="docutils literal"><span class="pre">weak</span></code> cache keys, non-strict
build plans also calculate <code class="docutils literal"><span class="pre">strong</span></code> cache keys. However, this is slightly
more complex. To calculate the <code class="docutils literal"><span class="pre">strong</span></code> cache key of an element, BuildStream
requires the <code class="docutils literal"><span class="pre">strong</span></code> cache keys of the build dependencies (and their runtime
dependencies).</p>
<p>The build dependencies of an element may have been updated since the artifact
was built. With the non-strict build plan the artifact will still be reused.
However, this means that we cannot use a <code class="docutils literal"><span class="pre">strong</span></code> cache key calculated purely
based on the element definitions. We need a cache key that matches the
environment at the time the artifact was built, not the current definitions.</p>
<p>The only way to get the correct <code class="docutils literal"><span class="pre">strong</span></code> cache key is by retrieving it from
the metadata stored in the artifact. As artifacts may need to be pulled from a
remote artifact cache, the <code class="docutils literal"><span class="pre">strong</span></code> cache key is not readily available early
in the build session. However, it can always be retrieved when an element is
about to be built, as the dependencies are guaranteed to be in the local
artifact cache at that point.</p>
<p><code class="docutils literal"><span class="pre">Element._get_cache_key_from_artifact()</span></code> extracts the <code class="docutils literal"><span class="pre">strong</span></code> cache key
from an artifact in the local cache. <code class="docutils literal"><span class="pre">Element._get_cache_key_for_build()</span></code>
calculates the <code class="docutils literal"><span class="pre">strong</span></code> cache key that is used for a particular build job.
This is used for the embedded metadata and also as key to store the artifact in
the cache.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cache Keys</a><ul>
<li><a class="reference internal" href="#structure">Structure</a></li>
<li><a class="reference internal" href="#cache-key-types">Cache Key Types</a></li>
<li><a class="reference internal" href="#strict-build-plan">Strict Build Plan</a></li>
<li><a class="reference internal" href="#non-strict-build-plan">Non-strict Build Plan</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Codethink Limited.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/cachekeys.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>